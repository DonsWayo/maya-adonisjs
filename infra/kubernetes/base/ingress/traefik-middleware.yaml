# Security Headers Middleware
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: maya-ingress
spec:
  headers:
    customResponseHeaders:
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
      Permissions-Policy: "camera=(), microphone=(), geolocation=(), payment=()"
    sslRedirect: true
    sslForceHost: true
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
    contentTypeNosniff: true
    browserXssFilter: true
    customFrameOptionsValue: "DENY"
    referrerPolicy: "strict-origin-when-cross-origin"
---
# Rate Limiting Middleware
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: maya-ingress
spec:
  rateLimit:
    average: 100
    burst: 200
    period: 1m
    sourceCriterion:
      ipStrategy:
        depth: 2
---
# CORS Middleware for Auth
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: cors-auth
  namespace: maya-ingress
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - PATCH
      - HEAD
    accessControlAllowHeaders:
      - "*"
    accessControlAllowOriginList:
      - https://main.maya.example.com
      - https://monitoring.maya.example.com
      - https://docs.maya.example.com
    accessControlAllowCredentials: true
    accessControlMaxAge: 86400
    addVaryHeader: true
---
# Basic Auth for MailHog (development)
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: basic-auth
  namespace: maya-ingress
spec:
  basicAuth:
    secret: mailhog-basic-auth
---
# Redirect to HTTPS
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: maya-ingress
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# Strip Prefix Middleware (if needed)
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: strip-prefix
  namespace: maya-ingress
spec:
  stripPrefix:
    prefixes:
      - /api
---
# Compress Responses
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: compress
  namespace: maya-ingress
spec:
  compress: {}
---
# Basic Auth Secret for MailHog
apiVersion: v1
kind: Secret
metadata:
  name: mailhog-basic-auth
  namespace: maya-ingress
type: kubernetes.io/basic-auth
data:
  # Default: admin/admin (change in production)
  # Generated with: htpasswd -nb admin admin | openssl base64
  auth: YWRtaW46JGFwcjEkSVhxLkU5T0EkRGFtbWl0RlBVbHhPVmhFQy56bWZyLgo=