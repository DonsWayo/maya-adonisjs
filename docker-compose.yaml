name: maya-adonisjs

services:
  # Database with PgAI integration
  pgsql:
    image: 'timescale/timescaledb-ha:pg17'
    container_name: 'maya_pgsql'
    ports:
      - '${DB_PORT:-5432}:5432'
    environment:
      POSTGRES_DB: '${DB_DATABASE:-default}'
      POSTGRES_USER: '${DB_USER:-postgres}'
      POSTGRES_PASSWORD: '${DB_PASSWORD:-secret}'
    volumes:
      - 'pgsql_data:/home/postgres/pgdata/data'
    networks:
      - maya_network
    command: ["-c", "ai.ollama_host=http://ollama:11434"]
    # Make Ollama dependency optional
    # depends_on:
    #   ollama:
    #     condition: service_started
    healthcheck:
      test: ['CMD', 'pg_isready', '-q', '-d', '${DB_DATABASE:-default}', '-U', '${DB_USER:-postgres}']
      retries: 3
      timeout: 5s
      interval: 10s

  # Redis for caching, session storage, and pub/sub
  redis:
    image: 'redis:7-alpine'
    container_name: 'maya_redis'
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - 'redis_data:/data'
    networks:
      - maya_network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      retries: 3
      timeout: 5s
      interval: 10s

  # ClickHouse for analytics
  clickhouse:
    image: 'clickhouse/clickhouse-server:23.8-alpine'
    container_name: 'maya_clickhouse'
    ports:
      - '${CLICKHOUSE_PORT:-8123}:8123' # HTTP port
      - '${CLICKHOUSE_NATIVE_PORT:-9000}:9000' # Native port
    volumes:
      - 'clickhouse_data:/var/lib/clickhouse'
    networks:
      - maya_network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--spider', '--tries=1', 'http://localhost:8123/ping']
      interval: 10s
      timeout: 5s
      retries: 3

  # Ollama for AI capabilities with Gemma 3 model
  ollama:
    image: 'ollama/ollama:latest'
    container_name: 'maya_ollama'
    volumes:
      - 'ollama_data:/root/.ollama'
    ports:
      - '${OLLAMA_PORT:-11434}:11434'
    networks:
      - maya_network
    command: ["serve"]
    # Disable health check for development
    # healthcheck:
    #   test: ["CMD", "curl", "-s", "-f", "http://localhost:11434/api/version" , "||" , "exit 0"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 20s
    # Temporarily disabled - uncomment to enable
    profiles: [ai]

  # PgAI vectorizer worker for background processing
  pgai_vectorizer:
    image: 'timescale/pgai-vectorizer-worker:latest'
    container_name: 'maya_pgai_vectorizer'
    environment:
      PGAI_VECTORIZER_WORKER_DB_URL: postgres://${DB_USER:-postgres}:${DB_PASSWORD:-secret}@pgsql:5432/${DB_DATABASE:-default}
      OLLAMA_HOST: http://ollama:11434
    command: ["--poll-interval", "5s", "--log-level", "DEBUG"]
    networks:
      - maya_network
    depends_on:
      pgsql:
        condition: service_healthy
      # Make Ollama dependency optional
      # ollama:
      #   condition: service_started
    # Temporarily disabled - uncomment to enable
    profiles: [ai]

  # Logto for authentication
  logto:
    image: 'svhd/logto:latest'
    container_name: 'maya_logto'
    depends_on:
      logto_postgres:
        condition: service_healthy
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm start"]
    ports:
      - '${LOGTO_PORT:-3001}:3001'
      - '${LOGTO_ADMIN_PORT:-3002}:3002'
    environment:
      - TRUST_PROXY_HEADER=1
      - DB_URL=postgres://postgres:p0stgr3s@logto_postgres:5432/logto
      # Set the endpoints for Logto to use with Traefik
      - ENDPOINT=http://logto.localhost
      - ADMIN_ENDPOINT=http://admin.logto.localhost
      # Explicitly set the cookie domain to match the hostname
      - COOKIE_DOMAIN=.localhost
    volumes:
      - 'logto_data:/opt/logto/packages/core/data'
    networks:
      - maya_network
    labels:
      - "traefik.enable=true"
      # Main Logto service configuration
      - "traefik.http.routers.logto.rule=Host(`logto.localhost`)"
      - "traefik.http.routers.logto.service=logto-main"
      - "traefik.http.services.logto-main.loadbalancer.server.port=3001"
      - "traefik.http.routers.logto.middlewares=logto-headers"
      # Admin Logto service configuration
      - "traefik.http.routers.logto-admin.rule=Host(`admin.logto.localhost`)"
      - "traefik.http.routers.logto-admin.service=logto-admin-ui"
      - "traefik.http.services.logto-admin-ui.loadbalancer.server.port=3002"
      - "traefik.http.routers.logto-admin.middlewares=logto-admin-headers"
      # Headers middleware for Logto
      - "traefik.http.middlewares.logto-headers.headers.customrequestheaders.X-Forwarded-Proto=http"
      - "traefik.http.middlewares.logto-headers.headers.customrequestheaders.X-Forwarded-Host=logto.localhost"
      # Headers middleware for Logto Admin
      - "traefik.http.middlewares.logto-admin-headers.headers.customrequestheaders.X-Forwarded-Proto=http"
      - "traefik.http.middlewares.logto-admin-headers.headers.customrequestheaders.X-Forwarded-Host=admin.logto.localhost"

  # Dedicated Postgres for Logto
  logto_postgres:
    image: 'postgres:17-alpine'
    container_name: 'maya_logto_postgres'
    user: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: p0stgr3s
      POSTGRES_DB: logto
    volumes:
      - 'logto_postgres_data:/var/lib/postgresql/data'
    networks:
      - maya_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Initialize Gemma 3 model in Ollama
  init_gemma3:
    image: 'curlimages/curl:latest'
    container_name: 'maya_init_gemma3'
    networks:
      - maya_network
    # Make Ollama dependency optional
    # depends_on:
    #   ollama:
    #     condition: service_healthy
    command: ["-X", "POST", "http://ollama:11434/api/pull", "-d", '{"name":"gemma3:2b-instruct-q4_0"}']
    restart: "no"
    # Temporarily disabled - uncomment to enable
    profiles: [ai]
    
  # MailHog for local email testing
  mailhog:
    image: 'mailhog/mailhog:latest'
    container_name: 'maya_mailhog'
    ports:
      - '${MAILHOG_SMTP_PORT:-1025}:1025' # SMTP server port
      - '${MAILHOG_UI_PORT:-8025}:8025' # Web UI port
    networks:
      - maya_network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8025"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mailhog.localhost`)"
      - "traefik.http.services.mailhog.loadbalancer.server.port=8025"
      
  # Web application (AdonisJS)
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
      target: development
    container_name: 'maya_web'
    restart: unless-stopped
    volumes:
      - ./apps/web:/app/apps/web
      - /app/apps/web/node_modules
      - web_uploads:/app/apps/web/uploads
      - web_tmp:/app/apps/web/tmp
    networks:
      - maya_network
    # Port is only exposed for direct access if needed
    # Traefik will handle routing through labels
    ports:
      - '${WEB_PORT:-3333}:3333'
    depends_on:
      pgsql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailhog:
        condition: service_healthy
    environment:
      HOST: 0.0.0.0
      PORT: 3333
      NODE_ENV: ${NODE_ENV:-development}
      DB_HOST: pgsql
      REDIS_HOST: redis
      # Internal URLs for container-to-container communication
      LOGTO_URL: http://logto:3001/oidc/auth
      LOGTO_AUTHORIZE_URL: http://logto:3001/oidc/auth
      LOGTO_ACCESS_TOKEN_URL: http://logto:3001/oidc/token
      LOGTO_USER_INFO_URL: http://logto:3001/oidc/me
      # Public URLs for browser redirects
      LOGTO_PUBLIC_URL: http://logto.localhost/oidc/auth
      LOGTO_PUBLIC_AUTHORIZE_URL: http://logto.localhost/oidc/auth
      LOGTO_PUBLIC_ACCESS_TOKEN_URL: http://logto.localhost/oidc/token
      LOGTO_PUBLIC_USER_INFO_URL: http://logto.localhost/oidc/me
      LOGTO_WEBHOOK_SIGNING_KEY: ${LOGTO_WEBHOOK_SIGNING_KEY:-q0TWqUY9CrxaDI0pXmeLQbnFnNRnoGQt}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`app.localhost`) || Host(`localhost`)"
      - "traefik.http.routers.web.service=web-app"
      - "traefik.http.services.web-app.loadbalancer.server.port=3333"
    # You can uncomment the following line to disable this service when not needed
    # profiles: [dev]
      
  # Documentation app (Next.js)
  docs:
    build:
      context: .
      dockerfile: ./apps/docs/Dockerfile
      target: development
    container_name: 'maya_docs'
    restart: unless-stopped
    volumes:
      - ./apps/docs:/app/apps/docs
      - /app/apps/docs/node_modules
    networks:
      - maya_network
    ports:
      - '${DOCS_PORT:-3300}:3300'
    environment:
      - NODE_ENV=${NODE_ENV:-development}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.docs.rule=Host(`docs.localhost`)"
      - "traefik.http.services.docs.loadbalancer.server.port=3300"
      
  # Placeholder for future web2 application
  # web2:
  #   container_name: 'maya_web2'
  #   restart: unless-stopped
  #   build:
  #     context: .
  #     dockerfile: apps/web2/Dockerfile
  #     target: development
  #   env_file:
  #     - apps/web2/.env
  #   volumes:
  #     - ./apps/web2:/app/apps/web2
  #     - /app/apps/web2/node_modules
  #   networks:
  #     - maya_network
  #   depends_on:
  #     pgsql:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   environment:
  #     HOST: 0.0.0.0
  #     PORT: 3334
  #     NODE_ENV: development
  #     DB_HOST: pgsql
  #     REDIS_HOST: redis
  #   ports:
  #     - '3334:3334'
  #   profiles: [web2]
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.web2.rule=Host(`web2.localhost`)"
  #     - "traefik.http.services.web2.loadbalancer.server.port=3334"

  # Placeholder for future web3 application
  # web3:
  #   container_name: 'maya_web3'
  #   restart: unless-stopped
  #   build:
  #     context: .
  #     dockerfile: apps/web3/Dockerfile
  #     target: development
  #   env_file:
  #     - apps/web3/.env
  #   volumes:
  #     - ./apps/web3:/app/apps/web3
  #     - /app/apps/web3/node_modules
  #   networks:
  #     - maya_network
  #   depends_on:
  #     pgsql:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   environment:
  #     HOST: 0.0.0.0
  #     PORT: 3335
  #     NODE_ENV: development
  #     DB_HOST: pgsql
  #     REDIS_HOST: redis
  #   ports:
  #     - '3335:3335'
  #   profiles: [web3]
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.web3.rule=Host(`web3.localhost`)"
  #     - "traefik.http.services.web3.loadbalancer.server.port=3335"
      
  # Traefik proxy for routing and service discovery
  traefik:
    image: traefik:v2.9
    container_name: 'maya_traefik'
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.forwardedHeaders.insecure=true"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.forwardedHeaders.insecure=true"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
    ports:
      - '${TRAEFIK_PORT:-80}:80'
      - '${TRAEFIK_SECURE_PORT:-443}:443'
      - '${TRAEFIK_DASHBOARD_PORT:-8080}:8080'  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - maya_network

  # MinIO - S3 compatible object storage
  minio:
    image: minio/minio:latest
    container_name: 'maya_minio'
    restart: unless-stopped
    profiles: ["dev"]
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    networks:
      - maya_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-api.rule=Host(`minio.localhost`)"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      - "traefik.http.routers.minio-console.rule=Host(`minio-console.localhost`)"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

networks:
  maya_network:
    name: maya-adonisjs_maya_network
    driver: bridge



volumes:
  pgsql_data:
  redis_data:
  clickhouse_data:
  logto_postgres_data:
  logto_data:
  ollama_data:
  web_uploads:
  web_tmp:
  minio_data:
